{"version":3,"sources":["bootstrap-functions.js","bootstrap-init-editor.js"],"names":["iframeID","msgPrefix","msgPrefixLen","length","lang","target","dentifrice_postMessage","setupMessageListener","eventMethod","window","addEventListener","eventer","messageEvent","dentifrice_postMessage_method","messageListener","type","final_html","data","content","event","isMessageForUs","msg","substr","logger","_debug","messageJson","JSON","parse","hasOwnProperty","value","_warn","dentifrice","settings","defaults","targetId","templateUrl","stylesUrl","configUrl","title","log","debug","hideTarget","anchorId","replaceAnchor","width","height","parseInt","outerHeight","locales","en","Please validate","fr","_initLang","userLang","navigator","language","userLanguage","_","text","locale","_initSettings","options","option","_findTarget","element","document","getElementById","_showValidationAlert","iframe","divCheck","createElement","id","textContent","parentNode","insertBefore","rect","getBoundingClientRect","iframeTop","top","scrollTop","heightElement","offsetHeight","widthElement","offsetWidth","posTop","parseFloat","posLeft","style","cssText","scrollTo","setTimeout","removeChild","init_dentifrice","_info","checkIfValidated","bootstrap","_initEditor","init","_output","enabled","console","display","assetsUrlBase","replace","absTest","templateUrlEncoded","encodeURIComponent","stylesUrlEncoded","test","configUrlEncoded","bootstrapRoot","allScripts","getElementsByTagName","re","forEach","call","tag","src","getAttribute","match","exec","editorUrl","setAttribute","border","anchor","replaceChild","appendChild","nextSibling"],"mappings":"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","file":"dentifrice.min.js","sourcesContent":["// Copyright (c) 2015 Oasiswork.\n// All Rights Reserved.\n//\n// This Source Code Form is subject to the\n// terms of the Mozilla Public License, v. 2.0.\n// If a copy of the MPL was not distributed with this file,\n// You can obtain one at\n// http://mozilla.org/MPL/2.0/.\n\n/*\n* Globals variables\n*/\nvar iframeID     = 'dentifriceIframe',\n    msgPrefix    = '[Dentifrice]',\n    msgPrefixLen = msgPrefix.length,\n    lang         = 'en',\n    target;\n\n/*\n* Listener Post Message Module\n*/\n\nvar dentifrice_postMessage = (function() {\n\n    /**\n     * Attach postMessage listener\n     */\n    var setupMessageListener = function () {\n      var eventMethod = window.addEventListener ? \"addEventListener\" : \"attachEvent\";\n      var eventer = window[eventMethod];\n      var messageEvent = eventMethod == \"attachEvent\" ? \"onmessage\" : \"message\";\n      eventer(messageEvent, dentifrice_postMessage_method.messageListener, false);\n    };\n\n    return {\n        setupMessageListener: setupMessageListener\n    }\n\n})();\n\nvar dentifrice_postMessage_method = (function() {\n    /*\n    * Type post Message response, extend it if you want\n    */\n    var type = {\n        \"final_html\": function(data) {\n            return data.content;\n        }\n    };\n    /*\n    * Callback listener for postMessages\n    */\n    var messageListener = function (event) {\n\n      function isMessageForUs () {\n        return msgPrefix === (('' + msg).substr(0,msgPrefixLen));\n      }\n\n      var msg = event.data;\n      if(msg.length > 0 && typeof msg === 'string' && isMessageForUs()) {\n        logger._debug('Received postmessage :' + msg);\n        /*\n        * Message Json\n        */\n        var messageJson = JSON.parse(msg.substr(msgPrefixLen));\n        /*\n        * Check if type is defined\n        */\n        if(type.hasOwnProperty(messageJson.type)) {\n            target.value = type[messageJson.type](messageJson)\n        }else {\n            logger._warn('Type undefined');\n        }\n\n\n\n      }else {\n        logger._debug('Received postmessage, but not for us :' + msg);\n      }\n\n    };\n\n    return {\n        type            : type,\n        messageListener : messageListener\n    }\n\n})();\n\n/*\n* Dentifrice Module\n*/\nvar dentifrice = (function () {\n  'use strict';\n\n  // Define some global variables and defaults\n  var\n    settings     = {},\n\n    defaults     = {\n      targetId       : 'dentifrice-textarea',\n      templateUrl    : null,\n      stylesUrl      : 'styles.html',\n      configUrl      : 'configuration.json',\n      title          : 'Dentifrice Newsletter',\n      lang           : null,\n      log            : true,\n      debug          : false,\n      hideTarget     : true,\n      anchorId       : null,\n      replaceAnchor  : false,\n      width          : 850,\n      height         : parseInt(window.outerHeight*0.8)\n    },\n\n    locales      = {\n      'en' : {\n        'Please validate' : 'Please validate your edition first !'\n      },\n      'fr' : {\n        'Please validate' : \"Veuillez valider l'Ã©diteur !\"\n      }\n    };\n\n  /**\n   * Initialize language to, in order of preference :\n   *   - language provided in settings\n   *   - browser language\n   *   - defaults to 'en'\n   */\n  var _initLang = function () {\n    var userLang = navigator.language || navigator.userLanguage;\n    if ( settings.lang && (settings.lang in locales) ) {\n      lang = settings.lang;\n    } else if ( userLang in locales) {\n      lang = userLang;\n    }\n    logger._debug('Setting locale to: ' + lang);\n  };\n\n  /**\n   * Returns the translated string matching \"text\" parameter\n   */\n  var _ = function (text) {\n    var locale = locales[lang];\n    return ( text in locale ? locale[text] : text );\n  };\n\n  /**\n   * Initialize settings from provided dictionnary\n   */\n  var _initSettings = function (options) {\n    for (var option in defaults) {\n      if (defaults.hasOwnProperty(option)) {\n        settings[option] = options.hasOwnProperty(option) ? options[option] : defaults[option];\n      }\n    }\n  };\n\n  /**\n   * Find the element where the generated HTML is to be pushed to\n   */\n  var _findTarget = function () {\n    var element = document.getElementById(settings.targetId);\n    if ( !element || 0 === element.length) {\n      logger._warn('Could not find element with ID: ' + settings.targetId);\n      return false;\n    } else {\n      logger._debug('Found element matching selector: ' + settings.targetId);\n      return element;\n    }\n  };\n\n  //Global\n  var _showValidationAlert = function () {\n    if(document.getElementById('dentifriceValidationAlert') === null) {\n\n      var iframe = document.getElementById(iframeID);\n\n      var divCheck = document.createElement('div');\n      divCheck.id = \"dentifriceValidationAlert\";\n      divCheck.textContent = _('Please validate');\n\n      iframe.parentNode.insertBefore(divCheck, iframe);\n\n      var rect = iframe.getBoundingClientRect();\n      var iframeTop = rect.top + iframe.parentNode.scrollTop;\n      var heightElement = divCheck.offsetHeight;\n      var widthElement = divCheck.offsetWidth;\n      var posTop = parseFloat(iframeTop) - parseFloat(heightElement) - 4;\n      var posLeft = parseFloat(settings.width) - parseFloat(widthElement);\n\n      divCheck.style.cssText = 'position: relative; top: -10px; left: ' + posLeft + 'px; opacity: 1;';\n\n      window.scrollTo(0, posTop -50);\n      setTimeout(function(){\n        if(divCheck.parentNode !== null) {\n          divCheck.parentNode.removeChild(divCheck);\n        }\n      }, 2000);\n\n    }\n  };\n\n  var init_dentifrice = function(options) {\n    // initialize settings\n    logger._info('Initializing settings');\n    _initSettings(options);\n\n    // Initialize language\n    logger._info('Initializing locale');\n    _initLang();\n\n    // Get the target element\n    logger._info('Getting target element');\n    target = _findTarget();\n\n    // Listen to messages from the iframe\n    logger._info('Setting up postMessages listener');\n    dentifrice_postMessage.setupMessageListener();\n  };\n\n  return {\n    checkIfValidated : function() {\n      if(target.value === \"\") {\n        _showValidationAlert();\n        return false;\n      } else {\n        return true;\n      }\n    },\n    settings: settings,\n    init_dentifrice : init_dentifrice,\n    bootstrap : function(options) {\n      // initialize\n      init_dentifrice(options);\n\n      // First check if template url was provided\n      // else, give up straight away\n      if ( !settings.templateUrl ) {\n        logger._warn('No template URL provided');\n        // Return false so we can test on the calling page\n        return false;\n      }\n\n      if (target) {\n\n        // Load the editor\n        logger._info('Initializing editor');\n        _initEditor.init();\n\n        return true;\n\n      } else {\n\n        logger._warn('Target element not found, aborting');\n        // Return false so we can test on the calling page\n        return false;\n\n      }\n    }\n  };\n\n})();\n\n/*\n* Logger Module\n*/\n\nvar logger = (function (dentifrice) {\n  /**\n   * Print messages to the console using provided level.\n   */\n  var _output = function (type, msg, enabled) {\n    if (true === enabled && 'object' === typeof window.console) {\n      console[type]('Dentifrice: ' + msg);\n    }\n  };\n  return {\n    /**\n     * Log warning messages to console.\n     * Always logged regardless of the 'log' setting.\n     */\n    _warn : function (msg) {\n      _output('warn', msg, true);\n    },\n\n    /**\n     * Log information messages to console.\n     * Only displayed if 'log' setting is true.\n     */\n    _info : function (msg) {\n        _output('info', msg, dentifrice.settings.log);\n    },\n\n    /**\n     * Log debug messages to console.\n     * Only displayed if 'debug' setting is true.\n     */\n    _debug : function (msg) {\n        _output('log', msg, dentifrice.settings.debug);\n    }\n  }\n\n})(dentifrice || {});\n","// Copyright (c) 2015 Oasiswork.\n// All Rights Reserved.\n//\n// This Source Code Form is subject to the\n// terms of the Mozilla Public License, v. 2.0.\n// If a copy of the MPL was not distributed with this file,\n// You can obtain one at\n// http://mozilla.org/MPL/2.0/.\n\n/**\n * Initialize the editor\n */\nvar _initEditor = (function (dentifrice) {\n  var init = function() {\n    // Hide the target and prepare iframe\n    if (dentifrice.settings.hideTarget) {\n      target.style.display = 'none';\n    }\n\n    var assetsUrlBase = dentifrice.settings.templateUrl.replace(/\\/[^\\/]*$/, '/');\n    var absTest = /^https?:\\/\\/|^\\/\\//i;\n\n    // Prepare template URL\n    var templateUrlEncoded = encodeURIComponent(dentifrice.settings.templateUrl);\n\n    // Prepare CSS URL\n    var stylesUrlEncoded = encodeURIComponent(assetsUrlBase + dentifrice.settings.stylesUrl);\n    // If an absolute stylesUrl was provided, use it instead\n    if ( absTest.test(dentifrice.settings.stylesUrl) ) {\n        stylesUrlEncoded = encodeURIComponent(dentifrice.settings.stylesUrl);\n    }\n\n    // Prepare config URL\n    var configUrlEncoded = encodeURIComponent(assetsUrlBase + dentifrice.settings.configUrl);\n    // f an absolute configUrl was provided, use it instead\n    if ( absTest.test(dentifrice.settings.configUrl) ) {\n        configUrlEncoded = encodeURIComponent(dentifrice.settings.configUrl);\n    }\n\n    // Get our own URL to use as base for the iFrame src\n    var bootstrapRoot = '';\n    var allScripts = document.getElementsByTagName('script');\n    var re = /^(.*)dentifrice\\.(min\\.)*js$/;\n    [].forEach.call(allScripts, function (tag) {\n      var src = tag.getAttribute('src');\n      var match = re.exec(src);\n      if (match) {\n        // Found a base url to use\n        bootstrapRoot = match[1];\n      }\n    });\n\n    var editorUrl = bootstrapRoot + 'editor.html?template=' + templateUrlEncoded + '&styles=' + stylesUrlEncoded + '&config=' + configUrlEncoded + '&lang=' + lang + '&title=' + dentifrice.settings.title;\n\n    var iframe = document.createElement('iframe');\n\n    iframe.id = iframeID;\n    iframe.setAttribute('src', editorUrl);\n    iframe.style.border = '0';\n    iframe.style.width = dentifrice.settings.width + 'px';\n    iframe.style.height = dentifrice.settings.height + 'px';\n\n    if (dentifrice.settings.anchorId) {\n      var anchor = document.getElementById(dentifrice.settings.anchorId);\n      if (0 === anchor.length) {\n        logger._warn('Could not find anchor element with ID: ' + dentifrice.settings.anchorId);\n      } else {\n        logger._debug('Found anchor element with ID: ' + dentifrice.settings.anchorId);\n        if (dentifrice.settings.replaceAnchor) {\n          logger._debug('Replacing anchor element with editor');\n          anchor.parentNode.replaceChild(iframe, anchor);\n        } else {\n          logger._debug('Inserting editor inside anchor element');\n          anchor.appendChild(iframe);\n        }\n      }\n    } else {\n      target.parentNode.insertBefore(iframe, target.nextSibling);\n    }\n  }\n\n  /*\n  * Return init function\n  */\n  return {\n    init: init\n  }\n})(dentifrice || {});\n"],"sourceRoot":"/source/"}