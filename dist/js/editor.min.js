/*!
 * This Source Code Form is subject to the terms of the
 * Mozilla Public License, v. 2.0. If a copy of the MPL was not distributed
 * with this file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
var dtfContentMode=function(t){"use strict";var e,a=function(){info("Entering ContentMode"),t.each(dtfEditor.blocksCatalog.configs,function(a,i){if(t(i.selector).addClass("dtf-block"),void 0!==i.urlckEditor){var n=JSON.parse(localStorage.getItem(i.selector));t(i.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor(n)}else t(i.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor();t(i.selector).find("*").addBack().filter(".dtf-imageUploadable").uploadify(),t(i.selector).find(".dtf-imageUploadable").closest("a").length>0&&(e=t(i.selector).find(".dtf-imageUploadable").parent("a").attr("href"),t(i.selector).find(".dtf-imageUploadable").parent("a").removeAttr("href").attr("data-href",e)),t(i.selector).find("*").addBack().filter(".dtf-resizable").makeResizable(),t(".ui-resizable-handle").is(":hidden")&&t(".ui-resizable-handle").show();var s=t("#dtf-content a:not(.cke_editable a)");s.each(function(){debug("Disabling clicks on link: "+this.href)}),s.on("click",function(t){t.preventDefault()})})},i=function(){info("Leaving ContentMode"),t.each(CKEDITOR.instances,function(t,e){e.destroy()}),t(".dtf-contentEditable").attr("contentEditable",!1),t(".sortable-element").removeClass("sortable-element"),t(".dtf-resizable").resizable("destroy"),t(".dtf-image-wrap").find(":not(.dtf-imageUploadable)").remove(),t("img.dtf-imageUploadable").unwrap(),t(".dtf-imageUploadable").closest("a").length>0&&(e=t(".dtf-imageUploadable").parent("a").data("href"),t(".dtf-imageUploadable").parent("a").removeAttr("data-href").attr("href",e))};return{enter:a,leave:i}}(jQuery),dtfLayoutMode=function(t){"use strict";var e=function(e){var a=e.closest("div");a.addClass("sortable-element"),t("#templateContainer").sortable({items:".sortable-element",placeholder:"ui-state-highlight",revert:!0,scrollSpeed:40,sort:function(e,a){var i=(t("#templateContainer").height()/2,a.item.height()/2/2),n=a.item.offset().top/2,s=parseFloat(n)+parseFloat(i);t(window).scrollTop(s)},start:function(e,a){a.placeholder.height(a.item.height()),t(".dtf-tr-element").remove(),t("#templateContainer > tbody > tr:not(.sortable-element)").css("opacity",.5);var i=a.item.height()/2,n=a.item.offset().top,s=parseFloat(n)+parseFloat(i)-100;window.scrollTo(0,s)},stop:function(e,a){t(".button-del").remove(),t(".dtf-block").each(function(){t(this).hasClass("dtf-changeable")?d(t(this)):r(t(this))}),t("#templateContainer > tbody > tr:not(.sortable-element)").css("opacity",1)}})},a=function(e){e.prev(".pure-button-del").length<=0&&!e.hasClass("isUnique")&&t(window.templates.blockDelButton).insertBefore(e).on("click",function(){var e=t(this).next(),a=e.closest("tr"),i=a.prev(),n=a.parent(),s=(a.next("tr"),l(e).hide());dtfEditor.pushToStack(function(){i.length>0?i.after(s):n.prepend(s),s.show(200)}),dtfEditor.flashUndo()})},i=function(){t(".dtf-catalog").hide(100),t(".dtf-add-bar .button-add:hidden").show(100)},n=function(){i(),t(this).hide(100),t(this).closest("div").find(".dtf-catalog").html(dtfEditor.blocksCatalog.get_gallery()).show(100)},s=function(){info("Entering LayoutMode");var a=t(".dtf-block").length;t(".dtf-block").each(function(i){i===a-1&&t(this).addClass("lastChild"),t(this).hasClass("dtf-changeable")?d(t(this)):(r(t(this)),e(t(".dtf-draggable")))}),t(".first-hidden").show(100),t(this).hide(100)},o=function(){info("Leaving LayoutMode"),t(".dtf-draft-block").closest("div").remove(),t(".button-del").remove(),t(".first-hidden").hide(100),t("#dtf-layout-mode").show(100),t(".dtf-deletion-border").removeClass("dtf-deletion-border"),t("#templateContainer").sortable("destroy")},r=function(e){var s=e.closest("div");if(e.addClass("dtf-deletion-border"),s.next("div").find(".dtf-draft-block").length<=0){var o=t(window.templates.blockAddBar);o.find("button").on("click",n),i(),s.after(o.fadeIn())}a(e)},d=function(e,s){var o=e.closest("div");if(e.addClass("dtf-deletion-border"),o.next("div").find(".dtf-draft-block").length<=0){if(!e.hasClass("lastChild")){var r=t(window.templates.blockAddBar);r.find("button").on("click",n),i(),o.after(r.fadeIn())}var d=t(window.templates.blockChange),l=o.find(".dtf-block").data("change-class"),f=l.split(",").join(" "),c=l.split(",");o.after(d),t.each(c,function(){e.closest("div").find(".dtf-block").hasClass(this)?d.find(".dtf-change-element").append('<div data-background="'+this+'" class="active dtf-background '+this+'"></div>'):d.find(".dtf-change-element").append('<div data-background="'+this+'" class="dtf-background '+this+'"></div>')}),e.closest("div").next().on("click",".dtf-background",function(){t(".dtf-background").removeClass("active"),t(this).addClass("active"),d.prev().find(".dtf-block").removeClass(f);var e=t(this).data("background");d.prev().find(".dtf-block").addClass(e)})}a(e)},l=function(e){var a,i=e.closest("div");a=e.hasClass("dtf-changeable")?t().add(i).add(i.next("div")).add(i.next("div").next("div")):t().add(i).add(i.next("div"));var n=a.clone(!0,!0);return a.hide(200,function(){t(this).remove()}),n};return{enter:s,leave:o,changeClass:d,equipBlock:r,deleteBlock:l}}(jQuery),dtfDraftsManager=function(t){"use strict";var e=(t("containerListDraft"),function(){spinner("show");var e=prompt(t.t("drafts.name_prompt"),t.t("drafts.default_name"));if(""!==e&&null!==e){var a=!0;if(draftStore.draftExists(e)&&(info("Draft name already exist: "+e),a=confirm(t.t("drafts.overwrite_confirm")),a===!0&&info("Overwriting draft named "+e)),a===!0){var i=new Date;i=i.toLocaleDateString()+" "+i.toLocaleTimeString();var n=dtfEditor.getContent(),s=dtfEditor.getUserStyles();draftStore.saveDraft(e,n,s,blocks_config,i)?dtfEditor.setMessage(t.t("drafts.save_ok"),"valid"):dtfEditor.setMessage(t.t("drafts.save_error"),"error")}}else""===e&&dtfEditor.setMessage(t.t("drafts.name_empty"),"error");spinner("hide")}),a=function(){t("#containerListDraft").removeClass("isActive")},i=function(){var e=t("#listDraft");e.empty();var a=draftStore.listDrafts();a.forEach(function(a){var i=t("<li/>");i.attr("data-objId",a.id);var n=t('<span class="draftDate">'+a.date+"</span>"),s=t('<span class="draftName">'+a.name+"</span>"),o=t('<span class="spanDelete fa fa-minus-circle"/>');i.append(n),i.append(s),i.append(o),i.on("click",function(e){if(confirm(t.t("drafts.restore_confirm")))try{draftStore.loadDraft(a.id)}catch(i){dtfEditor.setMessage(t.t("drafts.restore_error"),"error")}}),o.on("click",function(e){confirm(t.t("drafts.delete_confirm"))&&(draftStore.deleteDraft(a.id)?(i.remove(),dtfEditor.setMessage(t.t("drafts.delete_ok"),"valid")):dtfEditor.setMessage(t.t("drafts.delete_error"),"error")),e.stopPropagation()}),e.append(i)})},n=function(){var t=draftStore.listDrafts(),e=document.getElementById("listDraft");for(var a in t){var i=this.parentNode.getAttribute("data-objId");draftStore.deleteDraft(i)&&e.removeChild(draftLi)}};return{saveDraft:e,listDrafts:i,hideMenu:a,deleteAllDrafts:n}}(jQuery);!function(t){"use strict";t.fn.makeResizable=function(){return t.each(this,function(e,a){var i=t(a),n=(Math.round(i[0].naturalHeight/i[0].naturalWidth),i.closest("td").width()),s={maxWidth:n,minWidth:50,aspectRatio:!0,handles:"e, s, se"};"left"===i.data("resizable")&&(s.handles="sw, w, s"),i.resizable(s)}),this},t.fn.uploadify=function(){return t.each(this,function(e,a){function i(){l.hide(),u.show(),h.show(),c.hide(),r.show()}function n(){return r.hide(),l.show(),!1}function s(){u.hide(),h.hide(),c.show()}var o,r=t(window.templates.imageUploadForm),d=t(a),l=t(window.templates.imageUploadButton),f=d.width();r.i18n(),d.closest("a").length>0&&(o=d.parent("a").attr("href"),d.parent("a").removeAttr("href").attr("data-href",o)),d.wrap('<div class="dtf-image-wrap">'),d.parent().append(l),d.parent().append(r.hide());var c=r.find(".dtf-waiter"),u=r.find("input"),h=r.find(".upload-button"),p=r.find(".button-cancel");l.click(i),p.click(n),u.change(function(){var e=new FormData,a=r.find("#file")[0].files[0];e.append("file",a),e.append("width",f);var i=uploadStore.doUpload(e);if(null!==i){var o=void 0===d.data("resizable")?"right":d.data("resizable");d.hasClass("dtf-resizable")&&d.resizable("destroy");var l=d.parent(),c=t('<img data-resizable="'+o+'" class="dtf-resizable dtf-imageUploadable" src="'+i+'" width="'+d.width()+'px" />');l.replaceWith(c),setTimeout(function(){c.uploadify(),c.makeResizable()},1e3)}else dtfEditor.setMessage(t.t("upload.error"),"error");return n(),s(),!1})}),this}}(jQuery);var dtfEditor=function(t){"use strict";var e={blocks:t("<div>"),doms:{},configs:{},icons:{title:'<i class="icon-text">T</i>',paragraph:'<i class="fa fa-2x fa-align-justify"></i>',image:'<i class="fa fa-2x fa-picture-o"></i>',"1col_image_top":'<i class="fa fa-2x fa-picture-o"></i><br /><i class="fa fa-2x fa fa-align-justify"></i>',"2cols_image_top":'<i class="fa fa-2x fa-picture-o"></i><i class="fa fa-2x fa-picture-o"></i><br /><i class="fa fa-2x fa fa-align-justify"></i><i class="fa fa-2x fa fa-align-justify"></i>',"2cols_image_bottom":'<i class="fa fa-2x fa fa-align-justify"></i><i class="fa fa-2x fa fa-align-justify"></i><br /><i class="fa fa-2x fa-picture-o"></i><i class="fa fa-2x fa-picture-o"></i>',quote:'<i class="icon-text icon-quote">&rdquo;</i>',mixed_image_left:'<i class="fa fa-2x fa-picture-o"></i><i class="fa fa-2x fa-align-justify"></i>',mixed_image_right:'<i class="fa fa-2x fa-align-justify"></i><i class="fa fa-2x fa-picture-o"></i>',mixed_image_top:'<i class="fa fa-2x fa-picture-o"></i><br /><i class="fa fa-2x fa-align-justify"></i>',mixed_image_bottom:'<i class="fa fa-2x fa-align-justify"></i><br /><i class="fa fa-2x fa-picture-o"></i>'},get_gallery:function(){return this.blocks.children().clone(!0,!0)},get_dom:function(t){return this.doms[t].html.clone(!0,!0)},get_divClass:function(t){return this.doms[t].divClass},add:function(e,a,i){var n=this;if(a.isUnique)a.isUnique&&"undefined"!=typeof a.listChangeable?(t(a.selector).attr("data-change-class",a.listChangeable),t(a.selector).addClass("isUnique")):t(a.selector).addClass("isUnique");else{var s=t('<span class="dtable icon"><span class="dtable-cell"></span></span>'),o=t();if(a.icon in this.icons){s.find(".dtable-cell").html(this.icons[a.icon]);var d=a.icon;"caption"in a&&(d=a.caption),o=t('<span class="dblock">'+d+"</span>")}else s=t(a.icon);var f=t('<a class="dtf-block-choice" href="#">').attr("data-block-name",e).append(s);if(o.length&&f.append(o),"undefined"==typeof a.listChangeable)t(a.selector).addClass("dtf-draggable"),this.blocks.first().append(f);else{t(a.selector).attr("data-change-class",a.listChangeable);var c={html:t(a.selector).first().clone(!0,!0),divClass:t(a.selector).closest("div").attr("class")};i=c,t(a.selector).addClass("dtf-draggable"),this.blocks.first().append(f)}f.on("click",function(){var e=n.get_dom(t(this).attr("data-block-name"));e.addClass("dtf-draggable dtf-block");var a=t(window.templates.baseBlock);a.find(".dtf-block").replaceWith(e);var i=n.get_divClass(t(this).attr("data-block-name"));a.addClass(i);var s=t(this).closest("div.dtf-tr-element");return s.after(a.css("display","none")),e.hasClass("dtf-changeable")?dtfLayoutMode.changeClass(e):dtfLayoutMode.equipBlock(e),a.show(100),l.flash(),r.push(function(){dtfLayoutMode.deleteBlock(e)}),!1})}this.doms[e]=i,this.configs[e]=a}},a=function(){_.forOwn(blocks_config.styles,function(a,i){var n={html:t(a.selector).first().clone(!0,!0),divClass:t(a.selector).closest("div").attr("class")};if(e.add(i,a,n),void 0!==a.urlckEditor){var s=getAbsoluteUrl(a.urlckEditor);t.getJSON(s,function(e){e.ckEditor.language=settings.lang,t(a.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor(e.ckEditor),localStorage.setItem(a.selector,JSON.stringify(e.ckEditor))})}else t(a.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor({language:settings.lang})}),dtfContentMode.enter()},i=function(e){if(0!==e.length){var a,i=[],n=e.get(0).attributes,s=n.length;for(a=0;s>a;a++)"data-"===n[a].name.substring(0,5)&&i.push(n[a].name);t.each(i,function(t,a){e.removeAttr(a)})}},n=function(e){if(void 0===e||null===e)error("No HTML provided, cannot generate final document"),u(t.t("editor.valid_error"),"error");else{spinner("show");var a=s(),i=settings.appRootUrl+"final-boilerplate.html";t.get(i,function(i){i=i.replace("[[USER_TITLE]]",settings.title),i=i.replace("[[USER_STYLES]]",a),i=i.replace("[[USER_CONTENT]]",e),i=i.replace("[[USER_NOINLINE_ATTR]]",settings.noinlineAttr),i=i.replace(/\/\*(.|[\r\n])*?\*\//g,""),i=i.replace(/^\s*[\r\n]/gm,""),parent.postMessage(msgPrefix+i,"*"),spinner("hide"),u(t.t("editor.valid_ok"),"valid",!1),f(!0)}).fail(function(){warn("Could not get boilerplate from server, aborting content export"),spinner("hide"),u(t.t("editor.valid_error"),"error")})}},s=function(){var e=t("head").clone();return e.find("title,meta,link, script, style:not([data-userstyle])").remove(),i(e.find("style")),unescape(e.html())};String.prototype.htmlEncode=function(){var t={"“":"&ldquo;","”":"&rdquo;"};return this.replace(/[“”]/g,function(e){return t[e]||e})};var o=function(e){void 0===e&&(e=!1);try{dtfContentMode.leave();var a=t("#dtf-content").clone(),n=a.html();return dtfContentMode.enter(),e&&(a.find(".dtf-imageUploadable").each(function(){var e=t(this)[0].naturalWidth,a=t(this)[0].naturalHeight;0!==t(this).width()&&(e=t(this).width(),a=t(this).height()),t(this).attr("width",e),t(this).attr("height",a),t(this).removeAttr("class style")}),a.find(".dtf-upload").remove(),i(a.find(".dtf-changeable")),a.find(".dtf-contentEditable").removeAttr("contenteditable style"),a.find('*[class*="dtf"]').removeClass(function(t,e){return(e.match(/(^|\s)dtf-\S+/g)||[]).join(" ")}),a.find(".isUnique").removeClass("isUnique"),a.find("#templateContainer td:first > div").each(function(){t(this).before('<!--[if (gte mso 9)|(IE)]><table cellpadding="0" cellspacing="0" width="600" align="center"><tr><td><![endif]-->'),t(this).after("<!--[if (gte mso 9)|(IE)]></td></tr></table><![endif]-->")}),n=n.replace(/dtf.* /g,"")),n=n.htmlEncode(),n=n.replace(/<!--(?!\[if).*?-->/g,"")}catch(s){return null}},r={stack:[],push:function(t){this.stack.push(t)},undo:function(){var t=this.stack.pop();t?t():info("nothing to undo")}},d=function(e,a){this.el=t(e),this.stack=a,this.el.on("click",function(){a.undo()})};d.prototype.flash=function(){var t=this.el,e="rgb(202, 60, 60)",a=t.css("background-color");t.animate({backgroundColor:e},100,function(){t.animate({backgroundColor:a},100)})};var l,f=function(e){e?(t(".overlay").show(),t("#getList").hide(),t("#dtf-layout-mode").hide(),t("#saveDraft").hide(),t("#validateBtn").hide(),t("#resumeBtn").show()):(t("#resumeBtn").hide(),t("#getList").show(),t("#dtf-layout-mode").show(),t("#saveDraft").show(),t("#validateBtn").show(),t("#messages").fadeOut(100),t(".overlay").fadeOut(100))},c=function(){if(!t("#dtf-toolbar").length){var e=t(window.templates.layoutToolbar);l=new d(e.find("#undoBtn"),r);var a=e.find("#dtf-layout-mode");a.on("click",function(){t("#saveDraft").hide(),t("#validateBtn").hide(),t.proxy(dtfContentMode.leave,this)(),t.proxy(dtfLayoutMode.enter,this)()});var i=e.find("#dtf-content-mode");i.on("click",function(){t("#saveDraft").show(),t("#validateBtn").show(),t.proxy(dtfLayoutMode.leave,this)(),window.setTimeout(t.proxy(dtfContentMode.enter,this),100)});var s=e.find("#validateBtn");s.on("click",function(){n(o(!0))});var c=e.find("#resumeBtn");c.on("click",function(){parent.postMessage(msgPrefix,"*"),f(!1)});var u=e.find("#containerListDraft"),h=e.find("#saveDraft");h.on("click",function(){dtfDraftsManager.saveDraft()});var p=e.find("#getList");p.on("click",function(){dtfDraftsManager.listDrafts(),u.addClass("isActive"),t("body").addClass("sidebarMenuOpen")});var g=e.find("#closeListDraft");g.on("click",function(){u.removeClass("isActive"),t("body").removeClass("sidebarMenuOpen")}),t("body").append(e),t("#resumeBtn").hide(),e.i18n(),t("body").addClass("toolbarVisible")}},u=function(e,a,i){void 0===i&&(i=!0),t("#messages").length||t("body").append(t(window.templates.layoutMessages)),t("#messages").attr("class",""),t("#messages").text(e).addClass(a).fadeIn(300),i&&t("#messages").delay(2500).fadeOut(100)},h=function(){l.flash()},p=function(t){r.push(t)},g=function(){a(),c(),c()};return{blocksCatalog:e,setMessage:u,flashUndo:h,pushToStack:p,getContent:o,getUserStyles:s,load:g}}(jQuery);
//# sourceMappingURL=editor.min.js.map
