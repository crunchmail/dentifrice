/*!
 * This Source Code Form is subject to the terms of the
 * Mozilla Public License, v. 2.0. If a copy of the MPL was not distributed
 * with this file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
var dtfContentMode=function(t){"use strict";var e,a=function(){info("Entering ContentMode"),t.each(dtfEditor.blocksCatalog.configs,function(a,n){if(t(n.selector).data("default")||t(n.selector).remove(),t(n.selector).addClass("dtf-block"),void 0!==n.urlckEditor){var i=JSON.parse(localStorage.getItem(n.selector));t(n.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor(i)}else t(n.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor();t(n.selector).find("*").addBack().filter(".dtf-imageUploadable").uploadify(),t(n.selector).find(".dtf-imageUploadable").closest("a").length>0&&(e=t(n.selector).find(".dtf-imageUploadable").parent("a").attr("href"),t(n.selector).find(".dtf-imageUploadable").parent("a").removeAttr("href").attr("data-href",e)),t(n.selector).find("*").addBack().filter(".dtf-resizable").makeResizable(),t(".ui-resizable-handle").is(":hidden")&&t(".ui-resizable-handle").show();var o=t("#dtf-content a:not(.cke_editable a)");o.each(function(){debug("Disabling clicks on link: "+this.href)}),o.on("click",function(t){t.preventDefault()})})},n=function(){info("Leaving ContentMode"),t.each(CKEDITOR.instances,function(t,e){e.destroy()}),t(".dtf-contentEditable").attr("contentEditable",!1),t(".sortable-element").removeClass("sortable-element"),t(".dtf-resizable").resizable("destroy"),t(".dtf-image-wrap").find(":not(.dtf-imageUploadable)").remove(),t("img.dtf-imageUploadable").unwrap(),t(".dtf-imageUploadable").closest("a").length>0&&(e=t(".dtf-imageUploadable").parent("a").data("href"),t(".dtf-imageUploadable").parent("a").removeAttr("data-href").attr("href",e))};return{enter:a,leave:n}}(jQuery),dtfLayoutMode=function(t){"use strict";var e=function(e){var a=e.closest("div");a.addClass("sortable-element"),t("#templateContainer").sortable({items:".sortable-element",placeholder:"ui-state-highlight",revert:!0,scrollSpeed:40,sort:function(e,a){var n=(t("#templateContainer").height()/2,a.item.height()/2/2),i=a.item.offset().top/2,o=parseFloat(i)+parseFloat(n);t(window).scrollTop(o)},start:function(e,a){a.placeholder.height(a.item.height()),t(".dtf-tr-element").remove(),t("#templateContainer > tbody > tr:not(.sortable-element)").css("opacity",.5);var n=a.item.height()/2,i=a.item.offset().top,o=parseFloat(i)+parseFloat(n)-100;window.scrollTo(0,o)},stop:function(e,a){t(".button-del").remove(),t(".dtf-block").each(function(){t(this).hasClass("dtf-changeable")?s(t(this)):r(t(this))}),t("#templateContainer > tbody > tr:not(.sortable-element)").css("opacity",1)}})},a=function(e){e.prev(".pure-button-del").length<=0&&!e.hasClass("isUnique")&&t(window.templates.blockDelButton).insertBefore(e).on("click",function(){var e=t(this).next(),a=e.closest("tr"),n=a.prev(),i=a.parent(),o=(a.next("tr"),l(e).hide());dtfEditor.pushToStack(function(){n.length>0?n.after(o):i.prepend(o),o.show(200)})})},n=function(){t(".dtf-catalog").hide(100),t(".dtf-add-bar .button-add:hidden").show(100)},i=function(){n(),t(this).hide(100),t(this).closest("div").find(".dtf-catalog").html(dtfEditor.blocksCatalog.get_gallery()).show(100)},o=function(){info("Entering LayoutMode");var a=t(".dtf-block").length;t(".dtf-block").each(function(n){n===a-1&&t(this).addClass("lastChild"),t(this).hasClass("dtf-changeable")?s(t(this)):(r(t(this)),e(t(".dtf-draggable")))}),t(".first-hidden").show(100),t(this).hide(100)},d=function(){info("Leaving LayoutMode"),t(".dtf-draft-block").closest("div").remove(),t(".button-del").remove(),t(".first-hidden").hide(100),t("#dtf-layout-mode").show(100),t(".dtf-deletion-border").removeClass("dtf-deletion-border"),t("#templateContainer").sortable("destroy")},r=function(e){var o=e.closest("div");if(e.addClass("dtf-deletion-border"),o.next("div").find(".dtf-draft-block").length<=0){var d=t(window.templates.blockAddBar);d.find("button").on("click",i),n(),o.after(d.fadeIn())}a(e)},s=function(e,o){var d=e.closest("div");if(e.addClass("dtf-deletion-border"),d.next("div").find(".dtf-draft-block").length<=0){if(!e.hasClass("lastChild")){var r=t(window.templates.blockAddBar);r.find("button").on("click",i),n(),d.after(r.fadeIn())}var s=t(window.templates.blockChange),l=d.find(".dtf-block").data("change-class"),c=l.split(",").join(" "),f=l.split(",");d.after(s),t.each(f,function(){e.closest("div").find(".dtf-block").hasClass(this)?s.find(".dtf-change-element").append('<div data-background="'+this+'" class="active dtf-background '+this+'"></div>'):s.find(".dtf-change-element").append('<div data-background="'+this+'" class="dtf-background '+this+'"></div>')}),e.closest("div").next().on("click",".dtf-background",function(){t(".dtf-background").removeClass("active"),t(this).addClass("active"),s.prev().find(".dtf-block").removeClass(c);var e=t(this).data("background");s.prev().find(".dtf-block").addClass(e)})}a(e)},l=function(e){var a,n=e.closest("div");a=e.hasClass("dtf-changeable")?t().add(n).add(n.next("div")).add(n.next("div").next("div")):t().add(n).add(n.next("div"));var i=a.clone(!0,!0);return a.hide(200,function(){t(this).remove()}),i};return{enter:o,leave:d,changeClass:s,equipBlock:r,deleteBlock:l}}(jQuery),dtfDraftsManager=function(t){"use strict";var e=(t("containerListDraft"),function(){function e(e){e===!0?dtfEditor.setMessage(t.t("drafts.save_ok"),"valid"):dtfEditor.setMessage(t.t("drafts.save_error"),"error")}spinner("show");var a=prompt(t.t("drafts.name_prompt"),t.t("drafts.default_name"));if(""!==a&&null!==a){var n,i=!0;if(draftStore.draftExists(a)&&(info("Draft name already exist: "+a),i=confirm(t.t("drafts.overwrite_confirm")),i===!0&&(info("Overwriting draft named "+a),n=!0)),i===!0){var o=new Date;o=o.toLocaleDateString()+" "+o.toLocaleTimeString();var d=dtfEditor.getContent(),r=dtfEditor.getUserStyles();draftStore.saveDraft(a,d,r,blocks_config,o,e,n)}}else""===a&&dtfEditor.setMessage(t.t("drafts.name_empty"),"error");spinner("hide")}),a=function(){t("#containerListDraft").removeClass("isActive")},n=function(){function e(e){e===!0?dtfEditor.setMessage(t.t("drafts.delete_ok"),"valid"):dtfEditor.setMessage(t.t("drafts.delete_error"),"error")}var a=t("#listDraft");a.empty();var n=draftStore.listDrafts();n.forEach(function(n){var i=t("<li/>");i.attr("data-objId",n.id);var o=t('<span class="draftDate">'+n.date+"</span>"),d=t('<span class="draftName">'+n.name+"</span>"),r=t('<span class="spanDelete fa fa-minus-circle"/>');i.append(o),i.append(d),i.append(r),i.on("click",function(e){if(confirm(t.t("drafts.restore_confirm")))try{draftStore.loadDraft(n.id)}catch(a){dtfEditor.setMessage(t.t("drafts.restore_error"),"error")}}),r.on("click",function(a){confirm(t.t("drafts.delete_confirm"))&&draftStore.deleteDraft(n.id,e),a.stopPropagation()}),a.append(i)})},i=function(){function t(t){t===!0&&a.removeChild(draftLi)}for(var e=draftStore.listDrafts(),a=document.getElementById("listDraft"),n=0;n<e.length;n++){this.parentNode.getAttribute("data-objId");draftStore.deleteDraft(draft.id,t)}};return{saveDraft:e,listDrafts:n,hideMenu:a,deleteAllDrafts:i}}(jQuery);!function(t){"use strict";t.fn.makeResizable=function(){return t.each(this,function(e,a){var n=t(a),i=(Math.round(n[0].naturalHeight/n[0].naturalWidth),n.closest("td").width()),o={maxWidth:i,minWidth:50,aspectRatio:!0,handles:"e, s, se"};"left"===n.data("resizable")&&(o.handles="sw, w, s"),n.resizable(o)}),this},t.fn.uploadify=function(){return t.each(this,function(e,a){function n(){l.hide(),h.show(),u.show(),f.hide(),r.show()}function i(){return r.hide(),l.show(),!1}function o(){h.hide(),u.hide(),f.show()}var d,r=t(window.templates.imageUploadForm),s=t(a),l=t(window.templates.imageUploadButton),c=s.width();r.i18n(),s.closest("a").length>0&&(d=s.parent("a").attr("href"),s.parent("a").removeAttr("href").attr("data-href",d)),s.wrap('<div class="dtf-image-wrap">'),s.parent().append(l),s.parent().append(r.hide());var f=r.find(".dtf-waiter"),h=r.find("input"),u=r.find(".upload-button"),p=r.find(".button-cancel");l.click(n),p.click(i),h.change(function(){var e=new FormData,a=r.find("#file")[0].files[0];e.append("file",a),e.append("width",c);var n=uploadStore.doUpload(e);if(null!==n){var d=void 0===s.data("resizable")?"right":s.data("resizable");s.hasClass("dtf-resizable")&&s.resizable("destroy");var l=s.parent(),f=t('<img data-resizable="'+d+'" class="dtf-resizable dtf-imageUploadable" src="'+n+'" width="'+s.width()+'px" />');l.replaceWith(f),setTimeout(function(){f.uploadify(),f.makeResizable()},1e3)}else dtfEditor.setMessage(t.t("upload.error"),"error");return i(),o(),!1})}),this}}(jQuery);var dtfEditor=function(t){"use strict";var e,a={last_el_created:null,insert:function(e){var i=n.get_dom(e.attr("data-block-name"));i.addClass("dtf-draggable dtf-block");var o=t(window.templates.baseBlock);o.find(".dtf-block").replaceWith(i);var d=n.get_divClass(e.attr("data-block-name"));o.addClass(d);var r=e.closest("div.dtf-tr-element");r.after(o.css("display","none")),i.hasClass("dtf-changeable")?dtfLayoutMode.changeClass(i):dtfLayoutMode.equipBlock(i),a.last_el_created=o,o.show(100),l.push(function(){dtfLayoutMode.deleteBlock(i)})}},n={blocks:t("<div>"),doms:{},configs:{},get_gallery:function(){return this.blocks.children().clone(!0,!0)},get_dom:function(t){return this.doms[t].html.clone(!0,!0)},get_divClass:function(t){return this.doms[t].divClass},add:function(e,n,i){if(n.isUnique)n.isUnique&&"undefined"!=typeof n.listChangeable?(t(n.selector).attr("data-change-class",n.listChangeable),t(n.selector).addClass("isUnique")):t(n.selector).addClass("isUnique");else{var o=t('<span class="dtable icon"><span class="dtable-cell"></span></span>'),d=t();if(n.icon in blocksIcons){o.find(".dtable-cell").html(blocksIcons[n.icon]);var r=n.icon;"caption"in n&&(r=n.caption),d=t('<span class="dblock">'+r+"</span>")}else o=t(n.icon);var s=t('<a class="dtf-block-choice" href="#">').attr("data-block-name",e).append(o);if(d.length&&s.append(d),"undefined"==typeof n.listChangeable)t(n.selector).addClass("dtf-draggable"),this.blocks.first().append(s);else{t(n.selector).attr("data-change-class",n.listChangeable);var l={html:t(n.selector).first().clone(!0,!0),divClass:t(n.selector).closest("div").attr("class")};i=l,t(n.selector).addClass("dtf-draggable"),this.blocks.first().append(s)}s.on("click",function(e){a.insert(t(this)),e.preventDefault()})}this.doms[e]=i,this.configs[e]=n}},i=function(){n.blocks=t("<div>"),_.forOwn(blocks_config.styles,function(e,a){var i=t(e.selector).first().clone(!0,!0);i.attr("data-default","true");var o={html:i,divClass:t(e.selector).closest("div").attr("class")};if(n.add(a,e,o),void 0!==e.urlckEditor){var d=getAbsoluteUrl(e.urlckEditor);t.getJSON(d,function(a){a.ckEditor.language=settings.lang,t(e.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor(a.ckEditor),localStorage.setItem(e.selector,JSON.stringify(a.ckEditor))})}else t(e.selector).find(".dtf-contentEditable").attr("contentEditable",!0).ckeditor({language:settings.lang})}),dtfContentMode.enter()},o=function(e){if(0!==e.length){var a,n=[],i=e.get(0).attributes,o=i.length;for(a=0;o>a;a++)"data-"===i[a].name.substring(0,5)&&n.push(i[a].name);t.each(n,function(t,a){e.removeAttr(a)})}},d=function(e){if(void 0===e||null===e)error("No HTML provided, cannot generate final document"),p(t.t("editor.valid_error"),"error");else{spinner("show");var a=r(),n=settings.appRootUrl+"final-boilerplate.html";t.get(n,function(n){n=n.replace("[[USER_TITLE]]",settings.title),n=n.replace("[[USER_STYLES]]",a),n=n.replace("[[USER_CONTENT]]",e),n=n.replace("[[USER_NOINLINE_ATTR]]",settings.noinlineAttr),n=n.replace(/\/\*(.|[\r\n])*?\*\//g,""),n=n.replace(/^\s*[\r\n]/gm,""),postMessage.post("final_html",n),spinner("hide"),p(t.t("editor.valid_ok"),"valid",!1),f(!0)}).fail(function(){warn("Could not get boilerplate from server, aborting content export"),spinner("hide"),p(t.t("editor.valid_error"),"error")})}},r=function(){var e=t("head").clone();return e.find("title,meta,link, script, style:not([data-userstyle])").remove(),o(e.find("style")),unescape(e.html())};String.prototype.htmlEncode=function(){var t={"“":"&ldquo;","”":"&rdquo;"};return this.replace(/[“”]/g,function(e){return t[e]||e})};var s=function(e){void 0===e&&(e=!1);try{dtfContentMode.leave();var a=t("#dtf-content").clone(),n=a.html();return dtfContentMode.enter(),e&&(a.find(".dtf-imageUploadable").each(function(){var e=t(this)[0].naturalWidth,a=t(this)[0].naturalHeight;0!==t(this).width()&&(e=t(this).width(),a=t(this).height()),t(this).attr("width",e),t(this).attr("height",a),t(this).removeAttr("class style")}),a.find(".dtf-upload").remove(),o(a.find(".dtf-changeable")),a.find(".dtf-contentEditable").removeAttr("contenteditable style"),a.find('*[class*="dtf"]').removeClass(function(t,e){return(e.match(/(^|\s)dtf-\S+/g)||[]).join(" ")}),a.find(".isUnique").removeClass("isUnique"),a.find("#templateContainer td:first > div").each(function(){t(this).before('<!--[if (gte mso 9)|(IE)]><table cellpadding="0" cellspacing="0" width="600" align="center"><tr><td><![endif]-->'),t(this).after("<!--[if (gte mso 9)|(IE)]></td></tr></table><![endif]-->")}),n=n.replace(/dtf.* /g,"")),n=n.htmlEncode(),n=n.replace(/<!--(?!\[if).*?-->/g,"")}catch(i){return null}},l={stack:[],push:function(t){this.stack.push(t)},undo:function(){var t=this.stack.pop();t?t():info("nothing to undo")}},c=function(e,a){this.el=t(e),this.stack=a,this.el.on("click",function(){a.undo()})};c.prototype.flash=function(){var t=this.el,e="rgb(202, 60, 60)",a=t.css("background-color");t.animate({backgroundColor:e},100,function(){t.animate({backgroundColor:a},100)})};var f=function(e){e?(t(".overlay").show(),t("#getList").hide(),t("#dtf-layout-mode").hide(),t("#dtf-drop-down-btn").hide(),t("#validateBtn").hide(),t("#resumeBtn").show()):(t("#resumeBtn").hide(),t("#getList").show(),t("#dtf-layout-mode").show(),t("#dtf-drop-down-btn").show(),t("#validateBtn").show(),t("#messages").fadeOut(100),t(".overlay").fadeOut(100))},h=function(e,a){var n=t("<li/>");n.append(e),e.on("click",a),t("#dtf-drop-down").append(n)},u=function(){if(!t("#dtf-toolbar").length){var a=t(window.templates.layoutToolbar);e=new c(a.find("#undoBtn"),l);var n=a.find("#dtf-layout-mode");n.on("click",function(){t("#dtf-drop-down-btn").hide(),t("#validateBtn").hide(),t.proxy(dtfContentMode.leave,this)(),t.proxy(dtfLayoutMode.enter,this)()});var i=a.find("#dtf-content-mode");i.on("click",function(){t("#dtf-drop-down-btn").show(),t("#validateBtn").show(),t.proxy(dtfLayoutMode.leave,this)(),window.setTimeout(t.proxy(dtfContentMode.enter,this),100)});var o=a.find("#validateBtn");o.on("click",function(){d(s(!0))});var r=a.find("#resumeBtn");r.on("click",function(){parent.postMessage(msgPrefix,"*"),f(!1)});var h=a.find("#containerListDraft"),u=a.find("#saveDraft");u.on("click",function(){dtfDraftsManager.saveDraft()});var p=a.find("#getList");p.on("click",function(){dtfDraftsManager.listDrafts(),h.addClass("isActive"),t("body").addClass("sidebarMenuOpen")});var g=a.find("#closeListDraft");g.on("click",function(){h.removeClass("isActive"),t("body").removeClass("sidebarMenuOpen")}),t("body").append(a),t("#resumeBtn").hide(),a.i18n(),t("body").addClass("toolbarVisible")}},p=function(e,a,n){void 0===n&&(n=!0),t("#messages").length||t("body").append(t(window.templates.layoutMessages)),t("#messages").attr("class",""),t("#messages").text(e).addClass(a).fadeIn(300),n&&t("#messages").delay(2500).fadeOut(100)},g=function(t){l.push(t)},v=function(){i(),u(),u()};return{blocksCatalog:n,blockEvent:a,setMessage:p,addItemDropDown:h,pushToStack:g,getContent:s,getUserStyles:r,load:v}}(jQuery);
//# sourceMappingURL=editor.min.js.map
